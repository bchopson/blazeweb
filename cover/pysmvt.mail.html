<html>
<head>
<title>pysmvt.mail</title>
</head>
<body>
pysmvt.mail
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 371 lines<br/>
Missed: 61 lines<br/>
Skipped 77 lines<br/>
Percent: 85 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>import logging</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>import mimetypes</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>import os</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>import smtplib</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>import socket</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>import time</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>import random</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>import re</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from email import Charset, Encoders</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>from email.MIMEText import MIMEText</pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>from email.MIMEMultipart import MIMEMultipart</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>from email.MIMEBase import MIMEBase</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>from email.Header import Header</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>from email.Utils import formatdate, parseaddr, formataddr</pre></div>
<div class="skip"><span class="num"><pre> 15</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>from html2text import html2text</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>from markdown2 import markdown</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>from pysutils.helpers import tolist</pre></div>
<div class="skip"><span class="num"><pre> 19</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>from pysmvt import settings</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>from pysmvt.exceptions import SettingsError</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>from pysmvt.utils.encoding import smart_str, force_unicode</pre></div>
<div class="skip"><span class="num"><pre> 23</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>log = logging.getLogger(__name__)</pre></div>
<div class="skip"><span class="num"><pre> 25</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre># Don't BASE64-encode UTF-8 messages so that we avoid unwanted attention from</pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre># some spam filters.</pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>Charset.add_charset('utf-8', Charset.SHORTEST, Charset.QP, 'utf-8')</pre></div>
<div class="skip"><span class="num"><pre> 29</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 30</pre></span><pre># Default MIME type to use on attachments (if it is not explicitly given</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre># and cannot be guessed).</pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>DEFAULT_ATTACHMENT_MIME_TYPE = 'application/octet-stream'</pre></div>
<div class="skip"><span class="num"><pre> 33</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 34</pre></span><pre># Cache the hostname, but do it lazily: socket.getfqdn() can take a couple of</pre></div>
<div class="skip"><span class="num"><pre> 35</pre></span><pre># seconds, which slows down the restart of the server.</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>class CachedDnsName(object):</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>    def __str__(self):</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>        return self.get_fqdn()</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>    def get_fqdn(self):</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>        if not hasattr(self, '_fqdn'):</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>            self._fqdn = socket.getfqdn()</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>        return self._fqdn</pre></div>
<div class="skip"><span class="num"><pre> 44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>DNS_NAME = CachedDnsName()</pre></div>
<div class="skip"><span class="num"><pre> 46</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 47</pre></span><pre># Copied from Python standard library, with the following modifications:</pre></div>
<div class="skip"><span class="num"><pre> 48</pre></span><pre># * Used cached hostname for performance.</pre></div>
<div class="skip"><span class="num"><pre> 49</pre></span><pre># * Added try/except to support lack of getpid() in Jython (#5496).</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>def make_msgid(idstring=None):</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>    &quot;&quot;&quot;Returns a string suitable for RFC 2822 compliant Message-ID, e.g:</pre></div>
<div class="skip"><span class="num"><pre> 52</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>    &lt;20020201195627.33539.96671@nightshade.la.mastaler.com&gt;</pre></div>
<div class="skip"><span class="num"><pre> 54</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>    Optional idstring if given is a string used to strengthen the</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>    uniqueness of the message id.</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>    timeval = time.time()</pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>    utcdate = time.strftime('%Y%m%d%H%M%S', time.gmtime(timeval))</pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>        pid = os.getpid()</pre></div>
<div class="nocov"><span class="num"><pre> 62</pre></span><pre>    except AttributeError:</pre></div>
<div class="skip"><span class="num"><pre> 63</pre></span><pre>        # No getpid() in Jython, for example.</pre></div>
<div class="nocov"><span class="num"><pre> 64</pre></span><pre>        pid = 1</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>    randint = random.randrange(100000)</pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>    if idstring is None:</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>        idstring = ''</pre></div>
<div class="nocov"><span class="num"><pre> 68</pre></span><pre>    else:</pre></div>
<div class="nocov"><span class="num"><pre> 69</pre></span><pre>        idstring = '.' + idstring</pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>    idhost = DNS_NAME</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>    msgid = '&lt;%s.%s.%s%s@%s&gt;' % (utcdate, pid, randint, idstring, idhost)</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>    return msgid</pre></div>
<div class="skip"><span class="num"><pre> 73</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>class BadHeaderError(ValueError):</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>    pass</pre></div>
<div class="skip"><span class="num"><pre> 76</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>def forbid_multi_line_headers(name, val):</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>    &quot;&quot;&quot;Forbids multi-line headers, to prevent header injection.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>    val = force_unicode(val)</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>    if '\n' in val or '\r' in val:</pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>        raise BadHeaderError(&quot;Header values can't contain newlines (got %r for header %r)&quot; % (val, name))</pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>        val = val.encode('ascii')</pre></div>
<div class="nocov"><span class="num"><pre> 84</pre></span><pre>    except UnicodeEncodeError:</pre></div>
<div class="nocov"><span class="num"><pre> 85</pre></span><pre>        if name.lower() in ('to', 'from', 'cc'):</pre></div>
<div class="nocov"><span class="num"><pre> 86</pre></span><pre>            result = []</pre></div>
<div class="nocov"><span class="num"><pre> 87</pre></span><pre>            for item in val.split(', '):</pre></div>
<div class="nocov"><span class="num"><pre> 88</pre></span><pre>                nm, addr = parseaddr(item)</pre></div>
<div class="nocov"><span class="num"><pre> 89</pre></span><pre>                nm = str(Header(nm, settings.default.charset))</pre></div>
<div class="nocov"><span class="num"><pre> 90</pre></span><pre>                result.append(formataddr((nm, str(addr))))</pre></div>
<div class="nocov"><span class="num"><pre> 91</pre></span><pre>            val = ', '.join(result)</pre></div>
<div class="nocov"><span class="num"><pre> 92</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre> 93</pre></span><pre>            val = Header(val, settings.default.charset)</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>    else:</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>        if name.lower() == 'subject':</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>            val = Header(val)</pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>    return name, val</pre></div>
<div class="skip"><span class="num"><pre> 98</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>class SafeMIMEText(MIMEText):</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>    def __setitem__(self, name, val):</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>        name, val = forbid_multi_line_headers(name, val)</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>        MIMEText.__setitem__(self, name, val)</pre></div>
<div class="skip"><span class="num"><pre>103</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>class SafeMIMEMultipart(MIMEMultipart):</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>    def __setitem__(self, name, val):</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        name, val = forbid_multi_line_headers(name, val)</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>        MIMEMultipart.__setitem__(self, name, val)</pre></div>
<div class="skip"><span class="num"><pre>108</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>class SMTPConnection(object):</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>    A wrapper that manages the SMTP network connection.</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>113</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>    def __init__(self, host=None, port=None, username=None, password=None,</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>                 use_tls=None, fail_silently=False):</pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>        self.host = host or settings.smtp.host</pre></div>
<div class="cov"><span class="num"><pre>117</pre></span><pre>        self.port = port or settings.smtp.port</pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>        self.username = username or settings.smtp.user</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>        self.password = password or settings.smtp.password</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>        self.use_tls = (use_tls is not None) and use_tls or settings.smtp.use_tls</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>        self.fail_silently = fail_silently</pre></div>
<div class="cov"><span class="num"><pre>122</pre></span><pre>        self.connection = None</pre></div>
<div class="skip"><span class="num"><pre>123</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>    def open(self):</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>        Ensures we have a connection to the email server. Returns whether or</pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>        not a new connection was required (True or False).</pre></div>
<div class="cov"><span class="num"><pre>128</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>        if self.connection:</pre></div>
<div class="skip"><span class="num"><pre>130</pre></span><pre>            # Nothing to do if the connection is already open.</pre></div>
<div class="nocov"><span class="num"><pre>131</pre></span><pre>            return False</pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>        try:</pre></div>
<div class="skip"><span class="num"><pre>133</pre></span><pre>            # If local_hostname is not specified, socket.getfqdn() gets used.</pre></div>
<div class="skip"><span class="num"><pre>134</pre></span><pre>            # For performance, we use the cached FQDN for local_hostname.</pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>            self.connection = smtplib.SMTP(self.host, self.port,</pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>                                           local_hostname=DNS_NAME.get_fqdn())</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>            if self.use_tls:</pre></div>
<div class="nocov"><span class="num"><pre>138</pre></span><pre>                self.connection.ehlo()</pre></div>
<div class="nocov"><span class="num"><pre>139</pre></span><pre>                self.connection.starttls()</pre></div>
<div class="nocov"><span class="num"><pre>140</pre></span><pre>                self.connection.ehlo()</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>            if self.username and self.password:</pre></div>
<div class="nocov"><span class="num"><pre>142</pre></span><pre>                self.connection.login(self.username, self.password)</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>            return True</pre></div>
<div class="nocov"><span class="num"><pre>144</pre></span><pre>        except:</pre></div>
<div class="nocov"><span class="num"><pre>145</pre></span><pre>            if not self.fail_silently:</pre></div>
<div class="nocov"><span class="num"><pre>146</pre></span><pre>                raise</pre></div>
<div class="skip"><span class="num"><pre>147</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>    def close(self):</pre></div>
<div class="cov"><span class="num"><pre>149</pre></span><pre>        &quot;&quot;&quot;Closes the connection to the email server.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>150</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre>151</pre></span><pre>            try:</pre></div>
<div class="cov"><span class="num"><pre>152</pre></span><pre>                self.connection.quit()</pre></div>
<div class="nocov"><span class="num"><pre>153</pre></span><pre>            except socket.sslerror:</pre></div>
<div class="skip"><span class="num"><pre>154</pre></span><pre>                # This happens when calling quit() on a TLS connection</pre></div>
<div class="skip"><span class="num"><pre>155</pre></span><pre>                # sometimes.</pre></div>
<div class="nocov"><span class="num"><pre>156</pre></span><pre>                self.connection.close()</pre></div>
<div class="nocov"><span class="num"><pre>157</pre></span><pre>            except:</pre></div>
<div class="nocov"><span class="num"><pre>158</pre></span><pre>                if self.fail_silently:</pre></div>
<div class="nocov"><span class="num"><pre>159</pre></span><pre>                    return</pre></div>
<div class="nocov"><span class="num"><pre>160</pre></span><pre>                raise</pre></div>
<div class="nocov"><span class="num"><pre>161</pre></span><pre>        finally:</pre></div>
<div class="cov"><span class="num"><pre>162</pre></span><pre>            self.connection = None</pre></div>
<div class="skip"><span class="num"><pre>163</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>164</pre></span><pre>    def send_messages(self, email_messages):</pre></div>
<div class="cov"><span class="num"><pre>165</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>166</pre></span><pre>        Sends one or more EmailMessage objects and returns the number of email</pre></div>
<div class="cov"><span class="num"><pre>167</pre></span><pre>        messages sent.</pre></div>
<div class="cov"><span class="num"><pre>168</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>169</pre></span><pre>        if not email_messages:</pre></div>
<div class="nocov"><span class="num"><pre>170</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>171</pre></span><pre>        new_conn_created = self.open()</pre></div>
<div class="cov"><span class="num"><pre>172</pre></span><pre>        if not self.connection:</pre></div>
<div class="skip"><span class="num"><pre>173</pre></span><pre>            # We failed silently on open(). Trying to send would be pointless.</pre></div>
<div class="nocov"><span class="num"><pre>174</pre></span><pre>            return</pre></div>
<div class="cov"><span class="num"><pre>175</pre></span><pre>        num_sent = 0</pre></div>
<div class="cov"><span class="num"><pre>176</pre></span><pre>        for message in email_messages:</pre></div>
<div class="cov"><span class="num"><pre>177</pre></span><pre>            sent = self._send(message)</pre></div>
<div class="cov"><span class="num"><pre>178</pre></span><pre>            if sent:</pre></div>
<div class="cov"><span class="num"><pre>179</pre></span><pre>                num_sent += 1</pre></div>
<div class="cov"><span class="num"><pre>180</pre></span><pre>        if new_conn_created:</pre></div>
<div class="cov"><span class="num"><pre>181</pre></span><pre>            self.close()</pre></div>
<div class="cov"><span class="num"><pre>182</pre></span><pre>        return num_sent</pre></div>
<div class="skip"><span class="num"><pre>183</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>184</pre></span><pre>    def _send(self, email_message):</pre></div>
<div class="cov"><span class="num"><pre>185</pre></span><pre>        &quot;&quot;&quot;A helper method that does the actual sending.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>186</pre></span><pre>        if not email_message.recipients():</pre></div>
<div class="nocov"><span class="num"><pre>187</pre></span><pre>            return False</pre></div>
<div class="cov"><span class="num"><pre>188</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre>189</pre></span><pre>            if settings.email.is_live:</pre></div>
<div class="cov"><span class="num"><pre>190</pre></span><pre>                self.connection.sendmail(email_message.from_email,</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>                        email_message.recipients(),</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>                        email_message.message().as_string())</pre></div>
<div class="cov"><span class="num"><pre>193</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>194</pre></span><pre>                log.warn('email.is_live = False, email getting skipped')</pre></div>
<div class="nocov"><span class="num"><pre>195</pre></span><pre>        except:</pre></div>
<div class="nocov"><span class="num"><pre>196</pre></span><pre>            if not self.fail_silently:</pre></div>
<div class="nocov"><span class="num"><pre>197</pre></span><pre>                raise</pre></div>
<div class="nocov"><span class="num"><pre>198</pre></span><pre>            return False</pre></div>
<div class="cov"><span class="num"><pre>199</pre></span><pre>        return True</pre></div>
<div class="skip"><span class="num"><pre>200</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>201</pre></span><pre>class EmailMessage(object):</pre></div>
<div class="cov"><span class="num"><pre>202</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>203</pre></span><pre>    A container for email information.</pre></div>
<div class="cov"><span class="num"><pre>204</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>205</pre></span><pre>    content_subtype = 'plain'</pre></div>
<div class="cov"><span class="num"><pre>206</pre></span><pre>    multipart_subtype = 'mixed'</pre></div>
<div class="cov"><span class="num"><pre>207</pre></span><pre>    encoding = None     # None =&gt; use settings default</pre></div>
<div class="skip"><span class="num"><pre>208</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>209</pre></span><pre>    def __init__(self, subject='', body='', from_email=None, to=None, bcc=None,</pre></div>
<div class="cov"><span class="num"><pre>210</pre></span><pre>            connection=None, attachments=None, headers=None, reply_to=None, cc=None):</pre></div>
<div class="cov"><span class="num"><pre>211</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>212</pre></span><pre>        Initialize a single email message (which can be sent to multiple</pre></div>
<div class="cov"><span class="num"><pre>213</pre></span><pre>        recipients).</pre></div>
<div class="skip"><span class="num"><pre>214</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>215</pre></span><pre>        All strings used to create the message can be unicode strings (or UTF-8</pre></div>
<div class="cov"><span class="num"><pre>216</pre></span><pre>        bytestrings). The SafeMIMEText class will handle any necessary encoding</pre></div>
<div class="cov"><span class="num"><pre>217</pre></span><pre>        conversions.</pre></div>
<div class="cov"><span class="num"><pre>218</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>219</pre></span><pre>        if to:</pre></div>
<div class="cov"><span class="num"><pre>220</pre></span><pre>            assert not isinstance(to, basestring), '&quot;to&quot; argument must be a list or tuple'</pre></div>
<div class="cov"><span class="num"><pre>221</pre></span><pre>            self.to = list(to)</pre></div>
<div class="cov"><span class="num"><pre>222</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>223</pre></span><pre>            self.to = []</pre></div>
<div class="cov"><span class="num"><pre>224</pre></span><pre>        if bcc:</pre></div>
<div class="cov"><span class="num"><pre>225</pre></span><pre>            assert not isinstance(bcc, basestring), '&quot;bcc&quot; argument must be a list or tuple'</pre></div>
<div class="cov"><span class="num"><pre>226</pre></span><pre>            self.bcc = list(bcc)</pre></div>
<div class="cov"><span class="num"><pre>227</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>228</pre></span><pre>            self.bcc = settings.emails.bcc_defaults or []</pre></div>
<div class="cov"><span class="num"><pre>229</pre></span><pre>        if cc:</pre></div>
<div class="cov"><span class="num"><pre>230</pre></span><pre>            assert not isinstance(cc, basestring), '&quot;cc&quot; argument must be a list or tuple'</pre></div>
<div class="cov"><span class="num"><pre>231</pre></span><pre>            self.cc = list(cc)</pre></div>
<div class="cov"><span class="num"><pre>232</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>233</pre></span><pre>            self.cc = settings.emails.cc_defaults or []</pre></div>
<div class="cov"><span class="num"><pre>234</pre></span><pre>        self.from_email = from_email or settings.emails.from_default</pre></div>
<div class="cov"><span class="num"><pre>235</pre></span><pre>        self.reply_to = reply_to or settings.emails.reply_to</pre></div>
<div class="cov"><span class="num"><pre>236</pre></span><pre>        self.subject = subject</pre></div>
<div class="cov"><span class="num"><pre>237</pre></span><pre>        self.body = body</pre></div>
<div class="cov"><span class="num"><pre>238</pre></span><pre>        self.attachments = attachments or []</pre></div>
<div class="cov"><span class="num"><pre>239</pre></span><pre>        self.extra_headers = headers or {}</pre></div>
<div class="cov"><span class="num"><pre>240</pre></span><pre>        self.connection = connection</pre></div>
<div class="cov"><span class="num"><pre>241</pre></span><pre>        self._override_added = False</pre></div>
<div class="cov"><span class="num"><pre>242</pre></span><pre>        self._always_recipients_added = False</pre></div>
<div class="skip"><span class="num"><pre>243</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>244</pre></span><pre>    def get_connection(self, fail_silently=False):</pre></div>
<div class="cov"><span class="num"><pre>245</pre></span><pre>        if not self.connection:</pre></div>
<div class="cov"><span class="num"><pre>246</pre></span><pre>            self.connection = SMTPConnection(fail_silently=fail_silently)</pre></div>
<div class="cov"><span class="num"><pre>247</pre></span><pre>        return self.connection</pre></div>
<div class="skip"><span class="num"><pre>248</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>249</pre></span><pre>    def message(self):</pre></div>
<div class="cov"><span class="num"><pre>250</pre></span><pre>        self._extend_recipients()</pre></div>
<div class="cov"><span class="num"><pre>251</pre></span><pre>        self._perform_override()</pre></div>
<div class="cov"><span class="num"><pre>252</pre></span><pre>        encoding = self.encoding or settings.default.charset</pre></div>
<div class="cov"><span class="num"><pre>253</pre></span><pre>        msg = SafeMIMEText(smart_str(self.body, settings.default.charset),</pre></div>
<div class="cov"><span class="num"><pre>254</pre></span><pre>                           self.content_subtype, encoding)</pre></div>
<div class="cov"><span class="num"><pre>255</pre></span><pre>        if self.attachments:</pre></div>
<div class="cov"><span class="num"><pre>256</pre></span><pre>            body_msg = msg</pre></div>
<div class="cov"><span class="num"><pre>257</pre></span><pre>            msg = SafeMIMEMultipart(_subtype=self.multipart_subtype)</pre></div>
<div class="cov"><span class="num"><pre>258</pre></span><pre>            if self.body:</pre></div>
<div class="cov"><span class="num"><pre>259</pre></span><pre>                msg.attach(body_msg)</pre></div>
<div class="cov"><span class="num"><pre>260</pre></span><pre>            for attachment in self.attachments:</pre></div>
<div class="cov"><span class="num"><pre>261</pre></span><pre>                if isinstance(attachment, MIMEBase):</pre></div>
<div class="nocov"><span class="num"><pre>262</pre></span><pre>                    msg.attach(attachment)</pre></div>
<div class="cov"><span class="num"><pre>263</pre></span><pre>                else:</pre></div>
<div class="cov"><span class="num"><pre>264</pre></span><pre>                    msg.attach(self._create_attachment(*attachment))</pre></div>
<div class="skip"><span class="num"><pre>265</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>266</pre></span><pre>        msg['Subject'] = self.subject</pre></div>
<div class="cov"><span class="num"><pre>267</pre></span><pre>        if not self.from_email:</pre></div>
<div class="cov"><span class="num"><pre>268</pre></span><pre>            raise SettingsError('email must have a from address or settings.emails.from_default must be set')</pre></div>
<div class="cov"><span class="num"><pre>269</pre></span><pre>        msg['From'] = self.from_email</pre></div>
<div class="cov"><span class="num"><pre>270</pre></span><pre>        if self.to:</pre></div>
<div class="cov"><span class="num"><pre>271</pre></span><pre>            msg['To'] = ', '.join(self.to)</pre></div>
<div class="cov"><span class="num"><pre>272</pre></span><pre>        if self.cc:</pre></div>
<div class="cov"><span class="num"><pre>273</pre></span><pre>            msg['Cc'] = ', '.join(self.cc)</pre></div>
<div class="skip"><span class="num"><pre>274</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>275</pre></span><pre>        # Email header names are case-insensitive (RFC 2045), so we have to</pre></div>
<div class="skip"><span class="num"><pre>276</pre></span><pre>        # accommodate that when doing comparisons.</pre></div>
<div class="cov"><span class="num"><pre>277</pre></span><pre>        header_names = [key.lower() for key in self.extra_headers]</pre></div>
<div class="cov"><span class="num"><pre>278</pre></span><pre>        if 'date' not in header_names:</pre></div>
<div class="cov"><span class="num"><pre>279</pre></span><pre>            msg['Date'] = formatdate()</pre></div>
<div class="cov"><span class="num"><pre>280</pre></span><pre>        if 'message-id' not in header_names:</pre></div>
<div class="cov"><span class="num"><pre>281</pre></span><pre>            msg['Message-ID'] = make_msgid()</pre></div>
<div class="cov"><span class="num"><pre>282</pre></span><pre>        if self.reply_to:</pre></div>
<div class="cov"><span class="num"><pre>283</pre></span><pre>            msg['Reply-To'] = self.reply_to</pre></div>
<div class="skip"><span class="num"><pre>284</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>285</pre></span><pre>        for name, value in self.extra_headers.items():</pre></div>
<div class="cov"><span class="num"><pre>286</pre></span><pre>            msg[name] = value</pre></div>
<div class="cov"><span class="num"><pre>287</pre></span><pre>        return msg</pre></div>
<div class="skip"><span class="num"><pre>288</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>289</pre></span><pre>    def recipients(self):</pre></div>
<div class="cov"><span class="num"><pre>290</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>291</pre></span><pre>        Returns a list of all recipients of the email (includes direct</pre></div>
<div class="cov"><span class="num"><pre>292</pre></span><pre>        addressees, carbon copies, as well as Bcc entries).</pre></div>
<div class="cov"><span class="num"><pre>293</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>294</pre></span><pre>        self._extend_recipients()</pre></div>
<div class="cov"><span class="num"><pre>295</pre></span><pre>        self._perform_override()</pre></div>
<div class="cov"><span class="num"><pre>296</pre></span><pre>        return self.to + self.cc + self.bcc</pre></div>
<div class="skip"><span class="num"><pre>297</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>298</pre></span><pre>    def send(self, fail_silently=False):</pre></div>
<div class="cov"><span class="num"><pre>299</pre></span><pre>        &quot;&quot;&quot;Sends the email message.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>300</pre></span><pre>        return self.get_connection(fail_silently).send_messages([self])</pre></div>
<div class="skip"><span class="num"><pre>301</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>302</pre></span><pre>    def attach(self, filename=None, content=None, mimetype=None):</pre></div>
<div class="cov"><span class="num"><pre>303</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>304</pre></span><pre>        Attaches a file with the given filename and content. The filename can</pre></div>
<div class="cov"><span class="num"><pre>305</pre></span><pre>        be omitted (useful for multipart/alternative messages) and the mimetype</pre></div>
<div class="cov"><span class="num"><pre>306</pre></span><pre>        is guessed, if not provided.</pre></div>
<div class="skip"><span class="num"><pre>307</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>308</pre></span><pre>        If the first parameter is a MIMEBase subclass it is inserted directly</pre></div>
<div class="cov"><span class="num"><pre>309</pre></span><pre>        into the resulting message attachments.</pre></div>
<div class="cov"><span class="num"><pre>310</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>311</pre></span><pre>        if isinstance(filename, MIMEBase):</pre></div>
<div class="nocov"><span class="num"><pre>312</pre></span><pre>            assert content == mimetype == None</pre></div>
<div class="nocov"><span class="num"><pre>313</pre></span><pre>            self.attachments.append(filename)</pre></div>
<div class="cov"><span class="num"><pre>314</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>315</pre></span><pre>            assert content is not None</pre></div>
<div class="cov"><span class="num"><pre>316</pre></span><pre>            self.attachments.append([filename, content, mimetype])</pre></div>
<div class="skip"><span class="num"><pre>317</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>318</pre></span><pre>    def attach_file(self, path, mimetype=None):</pre></div>
<div class="cov"><span class="num"><pre>319</pre></span><pre>        &quot;&quot;&quot;Attaches a file from the filesystem.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>320</pre></span><pre>        filename = os.path.basename(path)</pre></div>
<div class="nocov"><span class="num"><pre>321</pre></span><pre>        content = open(path, 'rb').read()</pre></div>
<div class="nocov"><span class="num"><pre>322</pre></span><pre>        self.attach(filename, content, mimetype)</pre></div>
<div class="skip"><span class="num"><pre>323</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>324</pre></span><pre>    def _perform_override(self):</pre></div>
<div class="cov"><span class="num"><pre>325</pre></span><pre>        if not self._override_added and settings.emails.override:</pre></div>
<div class="cov"><span class="num"><pre>326</pre></span><pre>            self._override_added = True</pre></div>
<div class="cov"><span class="num"><pre>327</pre></span><pre>            body_prepend = '%s\n\nTo: %s  \nCc: %s  \nBcc: %s\n\n%s\n\n' % (</pre></div>
<div class="cov"><span class="num"><pre>328</pre></span><pre>                '-'*70,</pre></div>
<div class="cov"><span class="num"><pre>329</pre></span><pre>                ', '.join(self.to),</pre></div>
<div class="cov"><span class="num"><pre>330</pre></span><pre>                ', '.join(self.cc),</pre></div>
<div class="cov"><span class="num"><pre>331</pre></span><pre>                ', '.join(self.bcc),</pre></div>
<div class="cov"><span class="num"><pre>332</pre></span><pre>                '-'*70</pre></div>
<div class="cov"><span class="num"><pre>333</pre></span><pre>            )</pre></div>
<div class="cov"><span class="num"><pre>334</pre></span><pre>            self.to = tolist(settings.emails.override)</pre></div>
<div class="cov"><span class="num"><pre>335</pre></span><pre>            self.cc = []</pre></div>
<div class="cov"><span class="num"><pre>336</pre></span><pre>            self.bcc = []</pre></div>
<div class="cov"><span class="num"><pre>337</pre></span><pre>            if self.content_subtype == 'html':</pre></div>
<div class="cov"><span class="num"><pre>338</pre></span><pre>                body_prepend = markdown(body_prepend)</pre></div>
<div class="cov"><span class="num"><pre>339</pre></span><pre>                self.body = self._insert_after_html_body(body_prepend, self.body)</pre></div>
<div class="cov"><span class="num"><pre>340</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>341</pre></span><pre>                self.body = body_prepend + self.body</pre></div>
<div class="skip"><span class="num"><pre>342</pre></span><pre>            </pre></div>
<div class="skip"><span class="num"><pre>343</pre></span><pre>            # take care of any text/html alternative types</pre></div>
<div class="cov"><span class="num"><pre>344</pre></span><pre>            for attachment in self.attachments:</pre></div>
<div class="cov"><span class="num"><pre>345</pre></span><pre>                filename, content, mimetype = attachment</pre></div>
<div class="cov"><span class="num"><pre>346</pre></span><pre>                if not filename and content and mimetype == 'text/html':</pre></div>
<div class="cov"><span class="num"><pre>347</pre></span><pre>                    attachment[1] = self._insert_after_html_body(markdown(body_prepend), content)</pre></div>
<div class="skip"><span class="num"><pre>348</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>349</pre></span><pre>    def _extend_recipients(self):</pre></div>
<div class="cov"><span class="num"><pre>350</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>351</pre></span><pre>        Adds the bcc_always and cc_always recipients to the lists</pre></div>
<div class="cov"><span class="num"><pre>352</pre></span><pre>        if they are specified in the app settings.</pre></div>
<div class="cov"><span class="num"><pre>353</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>354</pre></span><pre>        if not self._always_recipients_added:</pre></div>
<div class="cov"><span class="num"><pre>355</pre></span><pre>            if settings.emails.bcc_always:</pre></div>
<div class="cov"><span class="num"><pre>356</pre></span><pre>                bcc_always = settings.emails.bcc_always</pre></div>
<div class="cov"><span class="num"><pre>357</pre></span><pre>                if isinstance(bcc_always, str):</pre></div>
<div class="nocov"><span class="num"><pre>358</pre></span><pre>                    bcc_always = [bcc_always]</pre></div>
<div class="cov"><span class="num"><pre>359</pre></span><pre>                self.bcc.extend(bcc_always)</pre></div>
<div class="cov"><span class="num"><pre>360</pre></span><pre>            if settings.emails.cc_always:</pre></div>
<div class="cov"><span class="num"><pre>361</pre></span><pre>                cc_always = settings.emails.cc_always</pre></div>
<div class="cov"><span class="num"><pre>362</pre></span><pre>                if isinstance(cc_always, str):</pre></div>
<div class="nocov"><span class="num"><pre>363</pre></span><pre>                    cc_always = [cc_always]</pre></div>
<div class="cov"><span class="num"><pre>364</pre></span><pre>                self.cc.extend(cc_always)</pre></div>
<div class="cov"><span class="num"><pre>365</pre></span><pre>            self._always_recipients_added = True    </pre></div>
<div class="skip"><span class="num"><pre>366</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>367</pre></span><pre>    def _create_attachment(self, filename, content, mimetype=None):</pre></div>
<div class="cov"><span class="num"><pre>368</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>369</pre></span><pre>        Converts the filename, content, mimetype triple into a MIME attachment</pre></div>
<div class="cov"><span class="num"><pre>370</pre></span><pre>        object.</pre></div>
<div class="cov"><span class="num"><pre>371</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>372</pre></span><pre>        if mimetype is None:</pre></div>
<div class="nocov"><span class="num"><pre>373</pre></span><pre>            mimetype, _ = mimetypes.guess_type(filename)</pre></div>
<div class="nocov"><span class="num"><pre>374</pre></span><pre>            if mimetype is None:</pre></div>
<div class="nocov"><span class="num"><pre>375</pre></span><pre>                mimetype = DEFAULT_ATTACHMENT_MIME_TYPE</pre></div>
<div class="cov"><span class="num"><pre>376</pre></span><pre>        basetype, subtype = mimetype.split('/', 1)</pre></div>
<div class="cov"><span class="num"><pre>377</pre></span><pre>        if basetype == 'text':</pre></div>
<div class="cov"><span class="num"><pre>378</pre></span><pre>            attachment = SafeMIMEText(smart_str(content,</pre></div>
<div class="cov"><span class="num"><pre>379</pre></span><pre>                settings.default.charset), subtype, settings.default.charset)</pre></div>
<div class="nocov"><span class="num"><pre>380</pre></span><pre>        else:</pre></div>
<div class="skip"><span class="num"><pre>381</pre></span><pre>            # Encode non-text attachments with base64.</pre></div>
<div class="nocov"><span class="num"><pre>382</pre></span><pre>            attachment = MIMEBase(basetype, subtype)</pre></div>
<div class="nocov"><span class="num"><pre>383</pre></span><pre>            attachment.set_payload(content)</pre></div>
<div class="nocov"><span class="num"><pre>384</pre></span><pre>            Encoders.encode_base64(attachment)</pre></div>
<div class="cov"><span class="num"><pre>385</pre></span><pre>        if filename:</pre></div>
<div class="nocov"><span class="num"><pre>386</pre></span><pre>            attachment.add_header('Content-Disposition', 'attachment',</pre></div>
<div class="nocov"><span class="num"><pre>387</pre></span><pre>                                  filename=filename)</pre></div>
<div class="cov"><span class="num"><pre>388</pre></span><pre>        return attachment</pre></div>
<div class="skip"><span class="num"><pre>389</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>390</pre></span><pre>    def _insert_after_html_body(self, content, html):</pre></div>
<div class="cov"><span class="num"><pre>391</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>392</pre></span><pre>            will insert content in html after &lt;body&gt; or at the front if &lt;body&gt;</pre></div>
<div class="cov"><span class="num"><pre>393</pre></span><pre>            isn't found</pre></div>
<div class="cov"><span class="num"><pre>394</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>395</pre></span><pre>        retval = re.sub('(&lt;body.*?&gt;)', r'\1%s' % content, html)</pre></div>
<div class="cov"><span class="num"><pre>396</pre></span><pre>        if len(retval) == len(html):</pre></div>
<div class="cov"><span class="num"><pre>397</pre></span><pre>            return content + html</pre></div>
<div class="cov"><span class="num"><pre>398</pre></span><pre>        return retval</pre></div>
<div class="skip"><span class="num"><pre>399</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>400</pre></span><pre>class EmailMultiAlternatives(EmailMessage):</pre></div>
<div class="cov"><span class="num"><pre>401</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>402</pre></span><pre>    A version of EmailMessage that makes it easy to send multipart/alternative</pre></div>
<div class="cov"><span class="num"><pre>403</pre></span><pre>    messages. For example, including text and HTML versions of the text is</pre></div>
<div class="cov"><span class="num"><pre>404</pre></span><pre>    made easier.</pre></div>
<div class="cov"><span class="num"><pre>405</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>406</pre></span><pre>    multipart_subtype = 'alternative'</pre></div>
<div class="skip"><span class="num"><pre>407</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>408</pre></span><pre>    def attach_alternative(self, content, mimetype=None):</pre></div>
<div class="cov"><span class="num"><pre>409</pre></span><pre>        &quot;&quot;&quot;Attach an alternative content representation.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>410</pre></span><pre>        self.attach(content=content, mimetype=mimetype)</pre></div>
<div class="skip"><span class="num"><pre>411</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>412</pre></span><pre>class MarkdownMessage(EmailMultiAlternatives):</pre></div>
<div class="cov"><span class="num"><pre>413</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>414</pre></span><pre>        Used the same way as EmailMessage, but the body is assumed to be</pre></div>
<div class="cov"><span class="num"><pre>415</pre></span><pre>        Markdown formatted, which is converted to HTML using Markdown and then</pre></div>
<div class="cov"><span class="num"><pre>416</pre></span><pre>        automatically attached as an alternative &quot;text/html&quot; content type.</pre></div>
<div class="cov"><span class="num"><pre>417</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>418</pre></span><pre>    def __init__(self, subject='', body='', from_email=None, to=None, bcc=None,</pre></div>
<div class="cov"><span class="num"><pre>419</pre></span><pre>            connection=None, attachments=None, headers=None, reply_to=None, cc=None):</pre></div>
<div class="cov"><span class="num"><pre>420</pre></span><pre>        EmailMultiAlternatives.__init__(self, subject, body, from_email, to, bcc,</pre></div>
<div class="cov"><span class="num"><pre>421</pre></span><pre>            connection, attachments, headers, reply_to, cc)</pre></div>
<div class="skip"><span class="num"><pre>422</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>423</pre></span><pre>        html_content = markdown(body)</pre></div>
<div class="cov"><span class="num"><pre>424</pre></span><pre>        self.attach_alternative(html_content, &quot;text/html&quot;)</pre></div>
<div class="skip"><span class="num"><pre>425</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>426</pre></span><pre>class HtmlMessage(EmailMultiAlternatives):</pre></div>
<div class="cov"><span class="num"><pre>427</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>428</pre></span><pre>        Used the same way as EmailMessage, but the body is assumed to be</pre></div>
<div class="cov"><span class="num"><pre>429</pre></span><pre>        HTML formatted, which is automatically attached as an alternative</pre></div>
<div class="cov"><span class="num"><pre>430</pre></span><pre>        &quot;text/html&quot; content type, and also converted to Markdown formatted text</pre></div>
<div class="cov"><span class="num"><pre>431</pre></span><pre>        for the main body.</pre></div>
<div class="cov"><span class="num"><pre>432</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>433</pre></span><pre>    def __init__(self, subject='', body='', from_email=None, to=None, bcc=None,</pre></div>
<div class="cov"><span class="num"><pre>434</pre></span><pre>            connection=None, attachments=None, headers=None, reply_to=None, cc=None):</pre></div>
<div class="cov"><span class="num"><pre>435</pre></span><pre>        html_content = body</pre></div>
<div class="cov"><span class="num"><pre>436</pre></span><pre>        body = html2text(body)</pre></div>
<div class="cov"><span class="num"><pre>437</pre></span><pre>        EmailMultiAlternatives.__init__(self, subject, body, from_email, to, bcc,</pre></div>
<div class="cov"><span class="num"><pre>438</pre></span><pre>            connection, attachments, headers, reply_to, cc)</pre></div>
<div class="skip"><span class="num"><pre>439</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>440</pre></span><pre>        self.attach_alternative(html_content, &quot;text/html&quot;)</pre></div>
<div class="skip"><span class="num"><pre>441</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>442</pre></span><pre>def get_email_class(format=None):</pre></div>
<div class="cov"><span class="num"><pre>443</pre></span><pre>    if format == 'markdown':</pre></div>
<div class="cov"><span class="num"><pre>444</pre></span><pre>        return MarkdownMessage</pre></div>
<div class="cov"><span class="num"><pre>445</pre></span><pre>    elif format == 'html':</pre></div>
<div class="cov"><span class="num"><pre>446</pre></span><pre>        return HtmlMessage</pre></div>
<div class="cov"><span class="num"><pre>447</pre></span><pre>    return EmailMessage</pre></div>
<div class="skip"><span class="num"><pre>448</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>449</pre></span><pre>def send_mail(subject, message, recipient_list, from_email=None, format='text',</pre></div>
<div class="cov"><span class="num"><pre>450</pre></span><pre>              fail_silently=False, auth_user=None, auth_password=None):</pre></div>
<div class="cov"><span class="num"><pre>451</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>452</pre></span><pre>    Easy wrapper for sending a single message to a recipient list. All members</pre></div>
<div class="cov"><span class="num"><pre>453</pre></span><pre>    of the recipient list will see the other recipients in the 'To' field.</pre></div>
<div class="skip"><span class="num"><pre>454</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>455</pre></span><pre>    If auth_user is None, the EMAIL_HOST_USER setting is used.</pre></div>
<div class="cov"><span class="num"><pre>456</pre></span><pre>    If auth_password is None, the EMAIL_HOST_PASSWORD setting is used.</pre></div>
<div class="cov"><span class="num"><pre>457</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>458</pre></span><pre>    connection = SMTPConnection(username=auth_user, password=auth_password,</pre></div>
<div class="cov"><span class="num"><pre>459</pre></span><pre>                                fail_silently=fail_silently)</pre></div>
<div class="cov"><span class="num"><pre>460</pre></span><pre>    email_class = get_email_class(format)</pre></div>
<div class="cov"><span class="num"><pre>461</pre></span><pre>    return email_class(subject, message, from_email, recipient_list,</pre></div>
<div class="cov"><span class="num"><pre>462</pre></span><pre>                        connection=connection).send()</pre></div>
<div class="skip"><span class="num"><pre>463</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>464</pre></span><pre>def send_mass_mail(datatuple, format='text', fail_silently=False, auth_user=None,</pre></div>
<div class="cov"><span class="num"><pre>465</pre></span><pre>                   auth_password=None):</pre></div>
<div class="cov"><span class="num"><pre>466</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>467</pre></span><pre>    Given a datatuple of (subject, message, from_email, recipient_list), sends</pre></div>
<div class="cov"><span class="num"><pre>468</pre></span><pre>    each message to each recipient list. Returns the number of e-mails sent.</pre></div>
<div class="skip"><span class="num"><pre>469</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>470</pre></span><pre>    If from_email is None, the emails.from_default setting is used.</pre></div>
<div class="cov"><span class="num"><pre>471</pre></span><pre>    If auth_user and auth_password are set, they're used to log in.</pre></div>
<div class="cov"><span class="num"><pre>472</pre></span><pre>    If auth_user is None, the EMAIL_HOST_USER setting is used.</pre></div>
<div class="cov"><span class="num"><pre>473</pre></span><pre>    If auth_password is None, the EMAIL_HOST_PASSWORD setting is used.</pre></div>
<div class="skip"><span class="num"><pre>474</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>475</pre></span><pre>    Note: The API for this method is frozen. New code wanting to extend the</pre></div>
<div class="cov"><span class="num"><pre>476</pre></span><pre>    functionality should use the EmailMessage class directly.</pre></div>
<div class="cov"><span class="num"><pre>477</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>478</pre></span><pre>    connection = SMTPConnection(username=auth_user, password=auth_password,</pre></div>
<div class="nocov"><span class="num"><pre>479</pre></span><pre>                                fail_silently=fail_silently)</pre></div>
<div class="nocov"><span class="num"><pre>480</pre></span><pre>    email_class = get_email_class(format)</pre></div>
<div class="nocov"><span class="num"><pre>481</pre></span><pre>    messages = [email_class(subject, message, sender, recipient)</pre></div>
<div class="nocov"><span class="num"><pre>482</pre></span><pre>                for subject, message, sender, recipient in datatuple]</pre></div>
<div class="nocov"><span class="num"><pre>483</pre></span><pre>    return connection.send_messages(messages)</pre></div>
<div class="skip"><span class="num"><pre>484</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>485</pre></span><pre>def _mail_admins(subject, message, format='text'):</pre></div>
<div class="cov"><span class="num"><pre>486</pre></span><pre>    &quot;&quot;&quot;used for testing&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>487</pre></span><pre>    email_class = get_email_class(format)</pre></div>
<div class="cov"><span class="num"><pre>488</pre></span><pre>    fromaddr = settings.emails.from_server or settings.emails.from_default</pre></div>
<div class="cov"><span class="num"><pre>489</pre></span><pre>    return email_class(settings.email.subject_prefix + subject, message,</pre></div>
<div class="cov"><span class="num"><pre>490</pre></span><pre>                 fromaddr, settings.emails.admins</pre></div>
<div class="cov"><span class="num"><pre>491</pre></span><pre>            )</pre></div>
<div class="skip"><span class="num"><pre>492</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>493</pre></span><pre>def mail_admins(subject, message, format='text', fail_silently=False):</pre></div>
<div class="cov"><span class="num"><pre>494</pre></span><pre>    &quot;&quot;&quot;Sends a message to the programmers, as defined by the emails.programmers setting.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>495</pre></span><pre>    return _mail_admins(subject, message, format).send(fail_silently=fail_silently)</pre></div>
<div class="skip"><span class="num"><pre>496</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>497</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>498</pre></span><pre>def _mail_programmers(subject, message, format='text'):</pre></div>
<div class="cov"><span class="num"><pre>499</pre></span><pre>    &quot;&quot;&quot;used for testing&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>500</pre></span><pre>    email_class = get_email_class(format)</pre></div>
<div class="cov"><span class="num"><pre>501</pre></span><pre>    fromaddr = settings.emails.from_server or settings.emails.from_default</pre></div>
<div class="cov"><span class="num"><pre>502</pre></span><pre>    return email_class(settings.email.subject_prefix + subject, message,</pre></div>
<div class="cov"><span class="num"><pre>503</pre></span><pre>               fromaddr , settings.emails.programmers</pre></div>
<div class="cov"><span class="num"><pre>504</pre></span><pre>            )</pre></div>
<div class="skip"><span class="num"><pre>505</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>506</pre></span><pre>def mail_programmers(subject, message, format='text', fail_silently=False):</pre></div>
<div class="cov"><span class="num"><pre>507</pre></span><pre>    &quot;&quot;&quot;Sends a message to the programmers, as defined by the emails.programmers setting.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>508</pre></span><pre>    return _mail_programmers(subject, message, format).send(fail_silently=fail_silently)</pre></div>
<div class="skip"><span class="num"><pre>509</pre></span><pre>    </pre></div>
</div>
</body>
</html>
