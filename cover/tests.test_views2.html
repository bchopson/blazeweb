<html>
<head>
<title>tests.test_views2</title>
</head>
<body>
tests.test_views2
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 285 lines<br/>
Missed: 0 lines<br/>
Skipped 98 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>from formencode.validators import Int</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>from nose.tools import eq_</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>from werkzeug import MultiDict, run_wsgi_app, Headers</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>from werkzeug.exceptions import BadRequest</pre></div>
<div class="skip"><span class="num"><pre>  5</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>from pysmvt import rg, user</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from pysmvt.views import View</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>from pysmvt.testing import inrequest</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from pysmvt.wrappers import Response</pre></div>
<div class="skip"><span class="num"><pre> 10</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 11</pre></span><pre># create the wsgi application that will be used for testing</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>import config</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>from newlayout.application import make_wsgi</pre></div>
<div class="skip"><span class="num"><pre> 14</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>def setup_module():</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>   make_wsgi()</pre></div>
<div class="skip"><span class="num"><pre> 17</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>@inrequest()</pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>def test_basic_view():</pre></div>
<div class="skip"><span class="num"><pre> 20</pre></span><pre>    # instantiate the view for test coverage purposes</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>            return 'hw'</pre></div>
<div class="skip"><span class="num"><pre> 24</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>    v = TestView({})</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>    r = v.process()</pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    assert isinstance(r, Response)</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>    eq_(r.data, 'hw')</pre></div>
<div class="skip"><span class="num"><pre> 30</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 31</pre></span><pre>@inrequest()</pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>def test_retval_edit():</pre></div>
<div class="skip"><span class="num"><pre> 33</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>            self.retval = 'foobar'</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>            return 'hw'</pre></div>
<div class="skip"><span class="num"><pre> 38</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>    v = TestView({})</pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>    r = v.process()</pre></div>
<div class="skip"><span class="num"><pre> 41</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>    assert isinstance(r, Response)</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>    eq_(r.data, 'foobar')</pre></div>
<div class="skip"><span class="num"><pre> 44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>@inrequest()</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>def test_direct_response_edit():</pre></div>
<div class="skip"><span class="num"><pre> 47</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>            rg.respctx.response.data = 'hw2'</pre></div>
<div class="skip"><span class="num"><pre> 51</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 52</pre></span><pre>    v = TestView({})</pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>    r = v.process()</pre></div>
<div class="skip"><span class="num"><pre> 54</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>    assert isinstance(r, Response)</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>    eq_(r.data, 'hw2')</pre></div>
<div class="skip"><span class="num"><pre> 57</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>@inrequest()</pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>def test_wsgi_app_return():</pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>            def hello_world(environ, start_response):</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>                start_response('200 OK', [('Content-Type', 'text/html')])</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>                return ['wsgi hw']</pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>            return hello_world</pre></div>
<div class="skip"><span class="num"><pre> 67</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>    v = TestView({})</pre></div>
<div class="cov"><span class="num"><pre> 69</pre></span><pre>    r = v.process()</pre></div>
<div class="skip"><span class="num"><pre> 70</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>    appiter, status, headers = run_wsgi_app(r, rg.environ)</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>    eq_(''.join(appiter), 'wsgi hw')</pre></div>
<div class="skip"><span class="num"><pre> 73</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 74</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>@inrequest()</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>def test_incorrect_return():</pre></div>
<div class="skip"><span class="num"><pre> 77</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>            return 2</pre></div>
<div class="skip"><span class="num"><pre> 81</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>    v = TestView({})</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        r = v.process()</pre></div>
<div class="skip"><span class="num"><pre> 85</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>    except TypeError, e:</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>        eq_('View &quot;TestView&quot; returned a value with an unexpected type: &lt;type \'int\'&gt;', str(e))</pre></div>
<div class="skip"><span class="num"><pre> 88</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>@inrequest('/foo?bar=baz')</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>def test_get_args():</pre></div>
<div class="skip"><span class="num"><pre> 91</pre></span><pre>    # URL args only</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>        def default(self, bar):</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>            return bar</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>    r = TestView({'bar':'2'}).process()</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>    assert r.data == '2'</pre></div>
<div class="skip"><span class="num"><pre> 97</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 98</pre></span><pre>    # no args causes 400</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>        def default(self, bar):</pre></div>
<div class="skip"><span class="num"><pre>101</pre></span><pre>            pass # pragma: no coverage</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>104</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>    except BadRequest, e:</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>107</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>108</pre></span><pre>    # register get args</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>            self.expect_getargs('bar')</pre></div>
<div class="skip"><span class="num"><pre>112</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>        def default(self, bar):</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>            return bar</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>    assert r.data == 'baz'</pre></div>
<div class="skip"><span class="num"><pre>117</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>@inrequest('/foo?bar=baz&amp;a1=a')</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>def test_arg_processor():</pre></div>
<div class="skip"><span class="num"><pre>120</pre></span><pre>    # register get args with a processor</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>122</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>            self.add_processor('bar')</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>            self.add_processor('a1')</pre></div>
<div class="skip"><span class="num"><pre>125</pre></span><pre>            # shouldn't cause a problem</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>            self.add_processor('nothere', int)</pre></div>
<div class="skip"><span class="num"><pre>127</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>128</pre></span><pre>        def default(self, bar, a1):</pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>            eq_(bar, 'baz')</pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>            return str(a1)</pre></div>
<div class="cov"><span class="num"><pre>131</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>    eq_(r.data, u'a')</pre></div>
<div class="skip"><span class="num"><pre>133</pre></span><pre>    # url values take precedence</pre></div>
<div class="cov"><span class="num"><pre>134</pre></span><pre>    r = TestView({'a1':2}).process()</pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>    eq_(r.data, '2')</pre></div>
<div class="skip"><span class="num"><pre>136</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>@inrequest('/foo?a=1&amp;b=b&amp;d=3')</pre></div>
<div class="cov"><span class="num"><pre>138</pre></span><pre>def test_arg_validation():</pre></div>
<div class="cov"><span class="num"><pre>139</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>            self.add_processor('a', int)</pre></div>
<div class="cov"><span class="num"><pre>142</pre></span><pre>            self.add_processor('b', int)</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>            self.add_processor('c', int)</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>            self.add_processor('d', Int)</pre></div>
<div class="cov"><span class="num"><pre>145</pre></span><pre>            try:</pre></div>
<div class="skip"><span class="num"><pre>146</pre></span><pre>                # try a bad processor type</pre></div>
<div class="cov"><span class="num"><pre>147</pre></span><pre>                self.add_processor('e', 5)</pre></div>
<div class="skip"><span class="num"><pre>148</pre></span><pre>                assert False</pre></div>
<div class="cov"><span class="num"><pre>149</pre></span><pre>            except TypeError, e:</pre></div>
<div class="cov"><span class="num"><pre>150</pre></span><pre>                if 'processor must be a Formencode validator or a callable' != str(e):</pre></div>
<div class="skip"><span class="num"><pre>151</pre></span><pre>                    raise # pragma: no cover</pre></div>
<div class="cov"><span class="num"><pre>152</pre></span><pre>        def default(self, a, b, c, d):</pre></div>
<div class="cov"><span class="num"><pre>153</pre></span><pre>            eq_(a, 1)</pre></div>
<div class="cov"><span class="num"><pre>154</pre></span><pre>            eq_(c, 2)</pre></div>
<div class="cov"><span class="num"><pre>155</pre></span><pre>            eq_(d, 3)</pre></div>
<div class="cov"><span class="num"><pre>156</pre></span><pre>            assert b is None, b</pre></div>
<div class="cov"><span class="num"><pre>157</pre></span><pre>    r = TestView({'c':u'2'}).process()</pre></div>
<div class="skip"><span class="num"><pre>158</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>159</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>160</pre></span><pre>@inrequest('/foo?a=1&amp;b=b')</pre></div>
<div class="cov"><span class="num"><pre>161</pre></span><pre>def test_arg_validation_with_strict():</pre></div>
<div class="skip"><span class="num"><pre>162</pre></span><pre>    # view level stric</pre></div>
<div class="cov"><span class="num"><pre>163</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>164</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>165</pre></span><pre>            self.strict_args = True</pre></div>
<div class="cov"><span class="num"><pre>166</pre></span><pre>            self.add_processor('b', int)</pre></div>
<div class="cov"><span class="num"><pre>167</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>168</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>169</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>170</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>171</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>172</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>173</pre></span><pre>    # arg level strict</pre></div>
<div class="cov"><span class="num"><pre>174</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>175</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>176</pre></span><pre>            self.add_processor('b', int, strict=True)</pre></div>
<div class="cov"><span class="num"><pre>177</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>178</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>179</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>180</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>181</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>182</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>183</pre></span><pre>    # non-strict failure with strict arg that passes</pre></div>
<div class="cov"><span class="num"><pre>184</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>185</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>186</pre></span><pre>            self.add_processor('a', int, strict=True)</pre></div>
<div class="cov"><span class="num"><pre>187</pre></span><pre>            self.add_processor('b', int, custom_msg='mycustom')</pre></div>
<div class="cov"><span class="num"><pre>188</pre></span><pre>        def default(self, a, b):</pre></div>
<div class="cov"><span class="num"><pre>189</pre></span><pre>            msgs = user.get_messages()</pre></div>
<div class="cov"><span class="num"><pre>190</pre></span><pre>            eq_(a, 1)</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>            assert b is None, b</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>            eq_(str(msgs[0]), 'error: b: mycustom')</pre></div>
<div class="cov"><span class="num"><pre>193</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>194</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>195</pre></span><pre>    # require implies strict; usage without processor</pre></div>
<div class="cov"><span class="num"><pre>196</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>197</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>198</pre></span><pre>            self.add_processor('c', required=True)</pre></div>
<div class="cov"><span class="num"><pre>199</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>200</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>201</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>202</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>203</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>204</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>205</pre></span><pre>    # required usage with a processor</pre></div>
<div class="cov"><span class="num"><pre>206</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>207</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>208</pre></span><pre>            self.add_processor('c', int, required=True)</pre></div>
<div class="cov"><span class="num"><pre>209</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>210</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>211</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>212</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>213</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>214</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>215</pre></span><pre>@inrequest('/foo?a=1&amp;a=2&amp;b=1&amp;b=2&amp;c=1&amp;c=2&amp;d=1&amp;d=2&amp;d=abc&amp;e=1&amp;g=foo&amp;h=1&amp;h=foo&amp;h=bar')</pre></div>
<div class="cov"><span class="num"><pre>216</pre></span><pre>def test_processing_with_lists():</pre></div>
<div class="cov"><span class="num"><pre>217</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>218</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>219</pre></span><pre>            self.add_processor('a')</pre></div>
<div class="cov"><span class="num"><pre>220</pre></span><pre>            self.add_processor('b', int)</pre></div>
<div class="cov"><span class="num"><pre>221</pre></span><pre>            self.add_processor('c', int, takes_list=False, show_msg=True)</pre></div>
<div class="cov"><span class="num"><pre>222</pre></span><pre>            self.add_processor('d', int, takes_list=True, strict=True)</pre></div>
<div class="cov"><span class="num"><pre>223</pre></span><pre>            self.add_processor('e', takes_list=True)</pre></div>
<div class="cov"><span class="num"><pre>224</pre></span><pre>            self.add_processor('f', takes_list=True)</pre></div>
<div class="cov"><span class="num"><pre>225</pre></span><pre>            self.add_processor('g', int, takes_list=True)</pre></div>
<div class="cov"><span class="num"><pre>226</pre></span><pre>            self.add_processor('h', int, takes_list=True, list_item_invalidates=True, show_msg=True)</pre></div>
<div class="cov"><span class="num"><pre>227</pre></span><pre>        def default(self, a, b, f, c, d, e, g, h):</pre></div>
<div class="cov"><span class="num"><pre>228</pre></span><pre>            msgs = user.get_messages()</pre></div>
<div class="cov"><span class="num"><pre>229</pre></span><pre>            eq_(a, '1')</pre></div>
<div class="cov"><span class="num"><pre>230</pre></span><pre>            eq_(b, 1)</pre></div>
<div class="skip"><span class="num"><pre>231</pre></span><pre>            # list when takes_list == False invalidates the whole argument</pre></div>
<div class="cov"><span class="num"><pre>232</pre></span><pre>            assert c is None</pre></div>
<div class="skip"><span class="num"><pre>233</pre></span><pre>            # test our error message</pre></div>
<div class="cov"><span class="num"><pre>234</pre></span><pre>            eq_(str(msgs[0]), 'error: c: multiple values not allowed')</pre></div>
<div class="skip"><span class="num"><pre>235</pre></span><pre>            # validator/convert and one invalid value results in only valid</pre></div>
<div class="skip"><span class="num"><pre>236</pre></span><pre>            # values and does not trigger strict</pre></div>
<div class="cov"><span class="num"><pre>237</pre></span><pre>            eq_(d, [1, 2])</pre></div>
<div class="skip"><span class="num"><pre>238</pre></span><pre>            # single item converted to list</pre></div>
<div class="cov"><span class="num"><pre>239</pre></span><pre>            eq_(e, ['1'])</pre></div>
<div class="skip"><span class="num"><pre>240</pre></span><pre>            # no values sent</pre></div>
<div class="cov"><span class="num"><pre>241</pre></span><pre>            eq_(f, [])</pre></div>
<div class="skip"><span class="num"><pre>242</pre></span><pre>            # all bad values</pre></div>
<div class="cov"><span class="num"><pre>243</pre></span><pre>            eq_(g, [])</pre></div>
<div class="skip"><span class="num"><pre>244</pre></span><pre>            # single bad value invalidates all values</pre></div>
<div class="cov"><span class="num"><pre>245</pre></span><pre>            eq_(h, [])</pre></div>
<div class="cov"><span class="num"><pre>246</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>247</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>248</pre></span><pre>    # no list strict</pre></div>
<div class="cov"><span class="num"><pre>249</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>250</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>251</pre></span><pre>            self.add_processor('c', int, takes_list=False, strict=True)</pre></div>
<div class="cov"><span class="num"><pre>252</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>253</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>254</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>255</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>256</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>257</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>258</pre></span><pre>    # list item invalidates &amp; strict</pre></div>
<div class="cov"><span class="num"><pre>259</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>260</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>261</pre></span><pre>            self.add_processor('h', int, takes_list=True, list_item_invalidates=True, strict=True)</pre></div>
<div class="cov"><span class="num"><pre>262</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>263</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>264</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>265</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>266</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>267</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>268</pre></span><pre>    # empty list should fail required</pre></div>
<div class="cov"><span class="num"><pre>269</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>270</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>271</pre></span><pre>            self.add_processor('f', int, takes_list=True, required=True)</pre></div>
<div class="cov"><span class="num"><pre>272</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>273</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>274</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>275</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>276</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>277</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>278</pre></span><pre>    # empty list after validation should fail required</pre></div>
<div class="cov"><span class="num"><pre>279</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>280</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>281</pre></span><pre>            self.add_processor('g', int, takes_list=True, required=True)</pre></div>
<div class="cov"><span class="num"><pre>282</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>283</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>284</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>285</pre></span><pre>    except BadRequest:</pre></div>
<div class="cov"><span class="num"><pre>286</pre></span><pre>        pass</pre></div>
<div class="skip"><span class="num"><pre>287</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>288</pre></span><pre>def test_call_method_changes():</pre></div>
<div class="cov"><span class="num"><pre>289</pre></span><pre>    v = View({})</pre></div>
<div class="cov"><span class="num"><pre>290</pre></span><pre>    assert v._cm_stack[0][0] == 'init_response'</pre></div>
<div class="cov"><span class="num"><pre>291</pre></span><pre>    v.add_call_method('foo')</pre></div>
<div class="cov"><span class="num"><pre>292</pre></span><pre>    assert v._cm_stack[1][0] == 'foo'</pre></div>
<div class="cov"><span class="num"><pre>293</pre></span><pre>    v.insert_call_method('bar', 'before', 'foo')</pre></div>
<div class="cov"><span class="num"><pre>294</pre></span><pre>    assert v._cm_stack[1][0] == 'bar', v._cm_stack</pre></div>
<div class="cov"><span class="num"><pre>295</pre></span><pre>    v.insert_call_method('baz', 'after', 'bar')</pre></div>
<div class="cov"><span class="num"><pre>296</pre></span><pre>    assert v._cm_stack[2][0] == 'baz', v._cm_stack</pre></div>
<div class="cov"><span class="num"><pre>297</pre></span><pre>    assert v._cm_stack[3][0] == 'foo', v._cm_stack</pre></div>
<div class="skip"><span class="num"><pre>298</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>299</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>300</pre></span><pre>        v.insert_call_method('foo', 'after', 'nothere')</pre></div>
<div class="cov"><span class="num"><pre>301</pre></span><pre>    except ValueError, e:</pre></div>
<div class="cov"><span class="num"><pre>302</pre></span><pre>        if 'target &quot;nothere&quot; was not found in the callstack' != str(e):</pre></div>
<div class="skip"><span class="num"><pre>303</pre></span><pre>            assert False, e</pre></div>
<div class="cov"><span class="num"><pre>304</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>305</pre></span><pre>        v.insert_call_method('whatever', 'behind', 'foo')</pre></div>
<div class="cov"><span class="num"><pre>306</pre></span><pre>    except ValueError, e:</pre></div>
<div class="cov"><span class="num"><pre>307</pre></span><pre>        if 'position &quot;behind&quot; not valid' not in str(e):</pre></div>
<div class="skip"><span class="num"><pre>308</pre></span><pre>            assert False, e</pre></div>
<div class="skip"><span class="num"><pre>309</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>310</pre></span><pre>@inrequest('/foo?a=1&amp;b=b&amp;d=3')</pre></div>
<div class="cov"><span class="num"><pre>311</pre></span><pre>def test_view_callstack():</pre></div>
<div class="cov"><span class="num"><pre>312</pre></span><pre>    methods_called = []</pre></div>
<div class="cov"><span class="num"><pre>313</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>314</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>315</pre></span><pre>            self.add_call_method('test1')</pre></div>
<div class="cov"><span class="num"><pre>316</pre></span><pre>            self.add_call_method('test2')</pre></div>
<div class="cov"><span class="num"><pre>317</pre></span><pre>        def test1(self):</pre></div>
<div class="cov"><span class="num"><pre>318</pre></span><pre>            methods_called.append('test1')</pre></div>
<div class="cov"><span class="num"><pre>319</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre>320</pre></span><pre>            methods_called.append('default')</pre></div>
<div class="cov"><span class="num"><pre>321</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>322</pre></span><pre>    eq_(methods_called, ['test1', 'default'])</pre></div>
<div class="skip"><span class="num"><pre>323</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>324</pre></span><pre>    methods_called = []</pre></div>
<div class="cov"><span class="num"><pre>325</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>326</pre></span><pre>        def get(self):</pre></div>
<div class="cov"><span class="num"><pre>327</pre></span><pre>            methods_called.append('get')</pre></div>
<div class="cov"><span class="num"><pre>328</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>329</pre></span><pre>    eq_(methods_called, ['get'])</pre></div>
<div class="skip"><span class="num"><pre>330</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>331</pre></span><pre>    # call stack abort</pre></div>
<div class="cov"><span class="num"><pre>332</pre></span><pre>    methods_called = []</pre></div>
<div class="cov"><span class="num"><pre>333</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>334</pre></span><pre>        def init(self):</pre></div>
<div class="cov"><span class="num"><pre>335</pre></span><pre>            self.add_call_method('test1')</pre></div>
<div class="cov"><span class="num"><pre>336</pre></span><pre>        def test1(self):</pre></div>
<div class="cov"><span class="num"><pre>337</pre></span><pre>            methods_called.append('test1')</pre></div>
<div class="cov"><span class="num"><pre>338</pre></span><pre>            self.retval = 'foo'</pre></div>
<div class="cov"><span class="num"><pre>339</pre></span><pre>            self.send_response()</pre></div>
<div class="cov"><span class="num"><pre>340</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>341</pre></span><pre>    eq_(methods_called, ['test1'])</pre></div>
<div class="skip"><span class="num"><pre>342</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>343</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>344</pre></span><pre>        pass</pre></div>
<div class="cov"><span class="num"><pre>345</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>346</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>347</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>348</pre></span><pre>    except Exception, e:</pre></div>
<div class="cov"><span class="num"><pre>349</pre></span><pre>        if 'there were no &quot;action&quot; methods on the view class' not in str(e):</pre></div>
<div class="skip"><span class="num"><pre>350</pre></span><pre>            assert False, e</pre></div>
<div class="skip"><span class="num"><pre>351</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>352</pre></span><pre>    # make sure an attirbute error in the default method gets passed out</pre></div>
<div class="cov"><span class="num"><pre>353</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>354</pre></span><pre>        def default(self):</pre></div>
<div class="cov"><span class="num"><pre>355</pre></span><pre>            baz = self.notthere</pre></div>
<div class="cov"><span class="num"><pre>356</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>357</pre></span><pre>        r = TestView({}).process()</pre></div>
<div class="skip"><span class="num"><pre>358</pre></span><pre>        assert False</pre></div>
<div class="cov"><span class="num"><pre>359</pre></span><pre>    except Exception, e:</pre></div>
<div class="cov"><span class="num"><pre>360</pre></span><pre>        if &quot;'TestView' object has no attribute 'notthere'&quot; != str(e):</pre></div>
<div class="skip"><span class="num"><pre>361</pre></span><pre>            assert False, e</pre></div>
<div class="skip"><span class="num"><pre>362</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>363</pre></span><pre>@inrequest('/foo', method='POST')</pre></div>
<div class="cov"><span class="num"><pre>364</pre></span><pre>def test_view_callstack_with_post():</pre></div>
<div class="cov"><span class="num"><pre>365</pre></span><pre>    methods_called = []</pre></div>
<div class="cov"><span class="num"><pre>366</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>367</pre></span><pre>        def post(self):</pre></div>
<div class="cov"><span class="num"><pre>368</pre></span><pre>            methods_called.append('post')</pre></div>
<div class="cov"><span class="num"><pre>369</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>370</pre></span><pre>    eq_(methods_called, ['post'])</pre></div>
<div class="skip"><span class="num"><pre>371</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>372</pre></span><pre>ajax_headers = Headers()</pre></div>
<div class="cov"><span class="num"><pre>373</pre></span><pre>ajax_headers.add('X-Requested-With', 'XMLHttpRequest')</pre></div>
<div class="skip"><span class="num"><pre>374</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>375</pre></span><pre>@inrequest('/foo', headers=ajax_headers)</pre></div>
<div class="cov"><span class="num"><pre>376</pre></span><pre>def test_view_callstack_with_ajax():</pre></div>
<div class="cov"><span class="num"><pre>377</pre></span><pre>    methods_called = []</pre></div>
<div class="cov"><span class="num"><pre>378</pre></span><pre>    class TestView(View):</pre></div>
<div class="cov"><span class="num"><pre>379</pre></span><pre>        def xhr(self):</pre></div>
<div class="cov"><span class="num"><pre>380</pre></span><pre>            methods_called.append('xhr')</pre></div>
<div class="cov"><span class="num"><pre>381</pre></span><pre>    r = TestView({}).process()</pre></div>
<div class="cov"><span class="num"><pre>382</pre></span><pre>    eq_(methods_called, ['xhr'])</pre></div>
<div class="skip"><span class="num"><pre>383</pre></span><pre></pre></div>
</div>
</body>
</html>
